<style>
    .kstate-debug a { background-color: rgba(0, 0, 0, 0.3); }
    .kstate-debug a.kstate-hover,
    .kstate-debug a:hover { background-color: rgba(0, 0, 0, 0.4); }
    /* 状态-begin */
    .kstate-fixed { position: fixed; }
    /* 状态-end */
    .kmods { overflow: hidden; background: #efefef; }
    .kmod { background: no-repeat center top; }
    .kmod-bd { *zoom: 1; position: relative; width: 1000px; margin: 0 auto; }
    .kmod-bd:before,
    .kmod-bd:after { display: table; content: ""; }
    .kmod-bd:after { clear: both; }
    .kmod-link,
    .kmod-plink,
    .kmod-blink { float: left; }
    .kmod-target { display: block; position: relative; visibility: hidden; }
    .kmod-header { height: 500px; background-image: url('/*${@IMAGE_URL}*//*${@STATE}*/-header.jpg'); }
    .kmod-logo { width: 115px; height: 115px; background: url('/*${@IMAGE_URL}*//*${@STATE}*/-logo.png') no-repeat; }
    /*# sourceMappingURL=index.css.map */

    /* 导航-begin */
    .kmod-nav-wrap { height: 0; }
    .kmod-nav { position: relative; top: 0; width: 100%; margin: 0 auto; padding-top: 80px; background: #ccc; z-index: 200; }
    .kmod-nav.kstate-fixed { position: fixed; }
    .kmod-nav1 { width: 120px; height: 550px; margin-left: -140px; background: url('/*${@IMAGE_URL}*/nav-a.png') no-repeat center 80px; }
    .kmod-nav1 .kmod-nav-hd { height: 170px; }
    .kmod-nav1 .kmod-nav-bd { margin: 0px; }
    .kmod-nav1 .kmod-nav-ft { height: 40px; }
    .kmod-nav1 .kmod-nav-ft .kmod-hash { height: 35px; }
    .kmod-nav1 .kmod-hash { display: block; width: 100%; height: 115px; }
    /* 导航-end */
    /*# sourceMappingURL=index.css.map */
    .kmod-footer { height: 250px; margin: 80px 0 40px; background-image: url('/*${@IMAGE_URL}*//*${@STATE}*/footer.png'); }
    .kmod-footer .kmod-btn { float: left; width: 311px; height: 57px; margin: 190px 0 0 334px; }
    /*# sourceMappingURL=index.css.map */


    /* 红包-begin */
    .kmod-coupon { position: relative; width: 482px; height: 144px; background: url("/*${IMAGE_URL}*/coupon-a.png") no-repeat center; }
    .kmod-coupon-btn { position: absolute; width: 163px; display: block; height: 47px; top: 39px; left: 231px; }
    .kmod-nav-coupon { position: relative; height: 173px; }
    .kmod-nav-coupon-btn { position: absolute; top: 143px; left: 7px; width: 106px; height: 25px; }
    .kstate-coupon-get .kmod-coupon { background-image: url("/*${IMAGE_URL}*/coupon-b.png"); }
    .kstate-coupon-get .kmod-nav1 { background-image: url("/*${IMAGE_URL}*/nav-b.png"); }
    .kstate-coupon-success .kmod-coupon { background-image: url("/*${IMAGE_URL}*/coupon-c.png"); }
    .kstate-coupon-success .kmod-nav1 { background-image: url("/*${IMAGE_URL}*/nav-c.png"); }
    /* 红包-end */
    /*# sourceMappingURL=index.css.map */
    /*# sourceMappingURL=index.css.map */
</style>
<div class="kmods">
    <!--模块头部-begin-->
    <div class="kmod-header kmod">
        <div class="kmod-bd">
            <div class="kmod-logo"></div>
        </div>
    </div>
    <!--模块头部-end-->
    <!--模块主体-begin-->
    <div class="kmod-body">
        <!--品购模块-begin-->
        {{each modules}}
        <div class="kmod kmod{{$index | kToIndex}}">
            {{if brands && ($index < brands.length)}}
            <!--锚点-begin-->
            <a class="kmod-target" id="kmod_hash{{$index | kToIndex}}" name="kmod_hash{{$index | kToIndex}}"></a>
            <!--锚点-end-->
            {{/if}}
            <div class="kmod-bd">
                {{if coupons && ($index < coupons.length)}}
                <!--红包-begin-->
                <div class="kmod-coupon"><a href="javascript:;" class="kmod-coupon-btn"></a></div>
                <!--红包-end-->
                {{/if}}
                {{if products}}
                <!--链接-begin-->
                {{each products as $v $i}}
                <a class="kmod-plink kmod-plink{{$i | kToIndex}}" href="javascript:;"></a>
                {{/each}}
                <!--链接-end-->
                {{/if}}
            </div>
        </div>
        {{/each}}
        <!--品购模块-end-->
    </div>
    <!--模块主体-end-->
    <!--模块导航-begin-->
    <div class="kmod kmod-nav-wrap">
        <div class="kmod-bd">
            {{each navigators}}
            <!--导航{{$index | kToIndex}}-begin-->
            <div class="kmod-nav kmod-nav1">
                <div class="kmod-nav-hd">
                    {{if coupons}}
                    <div class="kmod-nav-coupon"><a href="javascript:;" class="kmod-nav-coupon-btn"></a></div>
                    {{/if}}
                </div>
                <div class="kmod-nav-bd">
                    {{if brands}}
                    {{each brands as $v $i}}
                    <a class="kmod-hash kmod-hash{{$i | kToIndex}}" href="#kmod_hash{{$i | kToIndex}}" data-id="kmod_hash{{$i | kToIndex}}" target="_self"></a>
                    {{/each}}
                    {{/if}}
                </div>
                <div class="kmod-nav-ft">
                    <a class="kmod-hash" href="#" target="_self"></a>
                </div>
            </div>
            <!--导航{{$index | kToIndex}}-end-->
            {{/each}}
        </div>
    </div>
    <!--模块导航-end-->
    <!--模块尾部-begin-->
    <div class="kmod-footer kmod">
        <div class="kmod-bd">
            <a class="kmod-btn" target="_blank" href="http://kid.vip.com/"></a>
        </div>
    </div>
    <!--模块尾部-end-->


    <div class="kmod-coupon">
        <a href="javascript:;" class="kmod-coupon-btn"></a>
    </div>

    <div class="kmod-nav-coupon">
        <a href="javascript:;" class="kmod-nav-coupon-btn"></a>
    </div>
</div>
<script>
    (function(){


        addNavigators();
// 导航2
        function addNavigators() {

            var $nav = $('.kmod-nav');
            var offset = $nav.offset();

            var $win = $(window);
            var $doc = $(document);

            var $navTarget = $('.kmod-target');

            var $navTargetNew = $navTarget.map(function () {
                var $this = $(this);
                return {
                    top: $this.offset().top,
                    $el: $this,
                    $ctrl: $('[data-id=' + $this.attr('id') + ']')
                };
            });

            $navTargetNew.sort(function (a, b) {
                return a.top - b.top;
            });
            $win.on({
                'scroll.kmodNav': function () {
                    var scrollTop = $doc.scrollTop();

                    // 控制导航悬浮
                    $nav[scrollTop > offset.top ? 'addClass' : 'removeClass']('kstate-fixed');

                    // 控制导航focus效果
                    var len = $navTargetNew.length;
                    var index = 0;
                    do {
                        len -= 1;
                        index = len;
                    }
                    while (index >= 0 && scrollTop < $navTargetNew[index].top);

                    $navTargetNew.each(function (i, v) {
                        v.$ctrl && v.$ctrl.removeClass('kstate-hover');
                    });
                    index >= 0 && $navTargetNew[index].$ctrl.addClass('kstate-hover');

                    // 控制导航focus时底边线左右滑动
                    var lastIndex = $nav.data('index');
                    $nav.addClass('kstate-hover' + (index + 1));
                    if (!isNaN(lastIndex) && index !== lastIndex) {
                        $nav.removeClass('kstate-hover' + (lastIndex + 1));
                    }
                    $nav.data('index', index);

                }
            });

            //$doc.delegate('.kmod-nav a', {
            //  'click.kmodNav': function () {
            //
            //    //$('html, body').scrollTop(200);
            //  }
            //});

        }

        addProductLinks();
// 添加商品链接
        function addProductLinks() {

            var wh = $.Cookie.get('vip_wh') || 'VIP_NH';
            var whs = wh.toLocaleUpperCase();
            var plinksData = {
                "VIP_NH": ["626529-88420745", "626529-88420737", "626529-88420723", "626529-88420754", "626529-88420722", "626529-88420800", "626529-88420789", "626529-88420787", "626529-88420740", "626529-88420752", "626529-88420774", "651416-90659848", "651416-90659857", "651416-90659850", "651416-90659852", "651416-90659861", "651416-90659853", "651416-90659860", "651416-90659859", "651416-90659868", "651416-90659865", "651416-90659866", "665851-89410673", "665851-89410604", "665851-89410617", "665851-89410648", "665851-89410697", "665851-89410643", "665851-89410657", "665851-89410618", "665851-89410626", "665851-89410556", "665851-89410563"],
                "VIP_SH": ["626529-88420745", "626529-88420737", "626529-88420723", "626529-88420754", "626529-88420722", "626529-88420800", "626529-88420789", "626529-88420787", "626529-88420740", "626529-88420752", "626529-88420774", "651416-90659848", "651416-90659857", "651416-90659850", "651416-90659852", "651416-90659861", "651416-90659853", "651416-90659860", "651416-90659859", "651416-90659868", "651416-90659865", "651416-90659866", "665852-89412622", "665852-89412553", "665852-89412566", "665852-89412597", "665852-89412647", "665852-89412592", "665852-89412606", "665852-89412567", "665852-89412575", "665852-89412505", "665852-89412512"],
                "VIP_CD": ["626529-88420745", "626529-88420737", "626529-88420723", "626529-88420754", "626529-88420722", "626529-88420800", "626529-88420789", "626529-88420787", "626529-88420740", "626529-88420752", "626529-88420774", "651416-90659848", "651416-90659857", "651416-90659850", "651416-90659852", "651416-90659861", "651416-90659853", "651416-90659860", "651416-90659859", "651416-90659868", "651416-90659865", "651416-90659866", "665853-89412779", "665853-89412710", "665853-89412723", "665853-89412754", "665853-89412804", "665853-89412749", "665853-89412763", "665853-89412724", "665853-89412732", "665853-89412662", "665853-89412669"],
                "VIP_BJ": ["626529-88420745", "626529-88420737", "626529-88420723", "626529-88420754", "626529-88420722", "626529-88420800", "626529-88420789", "626529-88420787", "626529-88420740", "626529-88420752", "626529-88420774", "651416-90659848", "651416-90659857", "651416-90659850", "651416-90659852", "651416-90659861", "651416-90659853", "651416-90659860", "651416-90659859", "651416-90659868", "651416-90659865", "651416-90659866", "665854-89412936", "665854-89412867", "665854-89412880", "665854-89412911", "665854-89412961", "665854-89412906", "665854-89412920", "665854-89412881", "665854-89412889", "665854-89412819", "665854-89412826"],
                "VIP_HZ": ["626529-88420745", "626529-88420737", "626529-88420723", "626529-88420754", "626529-88420722", "626529-88420800", "626529-88420789", "626529-88420787", "626529-88420740", "626529-88420752", "626529-88420774", "651416-90659848", "651416-90659857", "651416-90659850", "651416-90659852", "651416-90659861", "651416-90659853", "651416-90659860", "651416-90659859", "651416-90659868", "651416-90659865", "651416-90659866", "665855-89413093", "665855-89413024", "665855-89413037", "665855-89413068", "665855-89413118", "665855-89413063", "665855-89413077", "665855-89413038", "665855-89413046", "665855-89412976", "665855-89412983"]
            };
            var plinks = plinksData[whs];
            $('.kmod-body .kmod-plink').each(function (i) {
                $(this).attr({
                    target: '_blank',
                    href: 'http://www.vip.com/detail-' + plinks[i] + '.html'
                });
            });

        }
        addBrandLinks();
// 添加专场链接
        function addBrandLinks() {

            var wh = $.Cookie.get('vip_wh') || 'VIP_NH';
            var whs = wh.toLocaleUpperCase();

            var blinksData = {
                "VIP_NH": ["667583", "667588", "667593"],
                "VIP_SH": ["667584", "667589", "667594"],
                "VIP_CD": ["667585", "667590", "667595"],
                "VIP_BJ": ["667586", "667591", "667596"],
                "VIP_HZ": ["667587", "667592", "667597"]
            };
            var blinks = blinksData[whs];

            // 顺序打乱时这样添加
            $('.kmod-body .kmod-blink').attr({target: '_blank'});
            $('.kmod-body .kmod-blink1').attr({href: 'http://list.vip.com/' + blinks[0] + '.html'});
            $('.kmod-body .kmod-blink2').attr({href: 'http://list.vip.com/' + blinks[1] + '.html'});
            $('.kmod-body .kmod-blink3').attr({href: 'http://list.vip.com/' + blinks[2] + '.html'});

        }
        addCoupons();

// 红包
        function addCoupons() {

            var bids = [679654];
            var map = {};

            //        getCoupons(bids);

            if ($.Cookie.get('VipLID')) {
                getCoupons(bids);
            } else {
                $('.kmods').addClass('kstate-coupon-get');
            }

            // 领取红包
            $('.kmods').delegate('.kmod-coupon-btn, .kmod-nav-coupon-btn', {
                'click.kmodCoupon': function (e) {
                    var $this = $(this);
                    if ($this.closest('.kstate-coupon-success').length > 0) return;

                    if ($.Cookie.get('VipLID')) {
                        bindCoupon();
                    } else {
                        VIPSHOP.login.init({
                            loginEvent: function () {
                                VIPSHOP.member.chk();//登录成功后回调
                                bindCoupon();
                            }
                        });
                    }
                }
            });


            // 获取档期红包
            function getCoupons() {
                var marsCid = $.Cookie.get('mars_cid');
                var promises = [];
                $.each(bids, function (i, bid) {
                    promises[i] = $.ajax({
                        url: 'http://act.vip.com/act/index_ajax.php',
                        dataType: 'jsonp',
                        data: {
                            service: 'NewCoupon.getAll',
                            mars_cid: marsCid,
                            bid: bid
                        }
                    });
                });

                $.when.apply($, promises).then(function (res) {
                    var args = arguments;
                    // 未领取红包数
                    var hasNotGetCount = 0;
                    // 已领取红包数
                    var hasGetCount = 0;
                    // 红包总数
                    var totalCount = 0;
                    // 任意红包有库存
                    var hasLeft = false;
                    $.each(bids, function (i, bid) {
                        try {
                            var obj = map[bid] = bids.length > 1 ? args[i][0] : args[i];
                            var coupon = obj.coupons[0];
                            // 有红包+未领取
                            if (coupon.left && coupon.status === 1) hasNotGetCount += 1;
                            // 有红包+已领取
                            if (coupon.left && coupon.status === 2) hasGetCount += 1;
                            // 任意红包有库存
                            if (!hasLeft && coupon.left) hasLeft = true;
                            totalCount += 1;
                        } catch (e) {
                        }
                    });


                    // 有红包时设置领取状态
                    if (hasLeft) {
                        $('.kmods').addClass(hasGetCount !== totalCount ? 'kstate-coupon-get' : 'kstate-coupon-success');
                    }

                });
            }

            // 绑定红包
            function bindCoupon() {
                var utype = VIPSHOP.UINFO.isNewUser() ? 1 : 2;
                var promises = [];
                $.each(map, function (bid, obj) {
                    var promise = $.ajax({
                        url: 'http://act.vip.com/act/index_ajax.php',
                        dataType: 'jsonp',
                        data: {
                            service: 'NewCoupon.bind',
                            bid: bid,
                            cid: obj.coupons[0].couponId,
                            utype: utype
                        }
                    });
                    promises.push(promise);
                });

                $.when.apply($, promises).then(function (res) {
                    var args = arguments;
                    var len = args.length;
                    getCoupons();
                    while (len--) {
                        if ((bids.length > 1 ? args[len][0] : args[len]).status === 1) {
                            //console.log('领取成功');
                            return;
                        }
                    }
                    //console.log('领取失败');
                });
            }
        }
    })();
</script>